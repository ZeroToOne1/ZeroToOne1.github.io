---
title: TCP非正常连接释放
date: 2021-10-18 22:17:59
tags:TCP
categories: 计算机网络
---

﻿# TCP连接释放请求过程（4次挥手）

1.A向B发起连接释放请求 
2.B向A发出请求确认报文(此时A已单方面关闭TCP连接)
3.B发送完自己的数据后，再向A发送连接释放确认报文
4.A收到B的确认报文后，再想A发出应答确认报文。

## 非正常连接释放情况

1. A/B同时发送连接释放请求，又同时发出连接释放确认报文 .   
       此时我认为A、B都发送完自己的数据，A、B互相向对方发出连接释放确认报文，表明A、B都释放了TCP连接。
2. B向A发送完最后的数据后，向A发送的最后一次连接释放确认报文丢失。       
       由于设置了TIME_WAIT时间，A会确保有足够的时间收到B重复的连接释放确认报文，如果A还没有收到确认报文，便会启动2MSL计时器，直到双方通信进入关闭状态。
3. B已经确认A的连接释放请求后，又收到A重复的连接释放请求。
       此时B可能再次同意A的连接释放请求，B向A再次发送同样的确认号。
4. B在向A发送最后的数据时收到A迟到的连接释放请求。  
   此时B会再次确认A的释放请求，然后向A发送最后的数据。5. A/B已经释放连接，但B又收到A重复的连接释放请求。   B收到A重复的连接释放请求后，B向A发送确认报文但是确认号是不正确的，A收到后会拒绝B的确认报文，B也拒绝A的连接释放请求。

  ## 总结

  在TCP连接释放过程中，建立的TIME_WAIT必须等待2MSL时间，这样避免了可能出现的不正常释放情况。TIME_WAIT确保有足够的时间让对端收到了ACK，如果被动关闭的那方没有收到ACK，就会触发被动端重发FIN。因为最后一次确认应答ACK报文段很有可能丢失，此时被动关闭方会重复这个FIN+ACK报文段。在这等待的2MSL时间被主动关闭方重新收到这个被动关闭方重发的FIN+ACK报文段，因此，主动关闭方会重新发送确认应答信息，从而重新启动2MSL计时器，直到通信双方都进入CLOSED状态。如果主动关闭方在TIME_WAIT状态不等待一段时间就直接释放连接并进入CLOSED状态，那么主动关闭方无法收到来自被动关闭方重发的FIN+ACK报文段，也就不会再发送一次确认ACK报文段，因此被动关闭方就无法正常地进入CLOSED状态。其次，在连接处于2MSL等待时，任何迟到的报文段将被丢弃，因为处于2MSL等待的，所以连接在这段时间内将不能被再用，这样就可以使下一个新的连接中不会出现这种旧的连接以前延迟的报文段。

